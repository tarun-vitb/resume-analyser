<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Resume Analyzer - Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .skill-badge {
            transition: all 0.3s ease;
        }
        
        .skill-badge:hover {
            transform: translateY(-2px);
        }
        
        .btn-enhanced {
            position: relative;
            overflow: hidden;
        }
        
        .btn-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-enhanced:hover::before {
            left: 100%;
        }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-indigo-600">AI Resume Analyzer - Fixed</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="showSection('upload')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-full font-semibold shadow-lg transition-all duration-200 hover:shadow-xl transform hover:scale-105">üìä Analyze</button>
                    <button onclick="showSection('matches')" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-full font-semibold shadow-lg transition-all duration-200 hover:shadow-xl transform hover:scale-105">üéØ Matches</button>
                </div>
            </div>
        </div>
    </nav>

    <section id="hero" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-20">
        <div class="max-w-4xl mx-auto text-center px-4">
            <h1 class="text-5xl font-bold mb-6">AI Resume Analyzer</h1>
            <p class="text-xl mb-8">Upload your resume and get instant AI feedback with accurate skill matching</p>
            <button onclick="showSection('upload')" class="bg-white text-indigo-600 px-10 py-4 rounded-full font-bold text-lg shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:scale-105 hover:bg-gray-50">
                üöÄ Start Analysis
            </button>
        </div>
    </section>

    <section id="upload" class="py-12 hidden">
        <div class="max-w-4xl mx-auto px-4">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-3xl font-bold text-center mb-8">Upload Resume</h2>
                
                <div class="mb-8">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                        <input type="file" id="resumeFile" accept=".pdf,.docx,.doc,.txt" class="hidden">
                        <div id="uploadArea" class="cursor-pointer" onclick="document.getElementById('resumeFile').click()">
                            <div class="text-6xl mb-4">üìÑ</div>
                            <p class="text-xl text-gray-600">Click to upload resume</p>
                            <p class="text-gray-500">PDF, DOCX, DOC, TXT supported</p>
                        </div>
                    </div>
                </div>

                <div class="mb-8">
                    <label class="block text-lg font-semibold mb-3">Job Description</label>
                    <textarea id="jobDescription" rows="8" class="w-full border rounded-lg p-4" placeholder="Paste job description here..."></textarea>
                </div>

                <button onclick="analyzeResume()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 btn-enhanced">
                    ü§ñ Analyze Resume
                </button>
            </div>
        </div>
    </section>

    <section id="results" class="py-12 hidden">
        <div class="max-w-6xl mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                    <div id="fitScore" class="text-4xl font-bold text-indigo-600 mb-2">--</div>
                    <div class="text-gray-600">Fit Score</div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                    <div id="selectionProb" class="text-4xl font-bold text-green-600 mb-2">--</div>
                    <div class="text-gray-600">Selection Probability</div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                    <div id="skillMatch" class="text-4xl font-bold text-purple-600 mb-2">--</div>
                    <div class="text-gray-600">Skill Match</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                    <div class="flex items-center mb-4">
                        <div class="bg-green-100 p-2 rounded-full mr-3">
                            <span class="text-2xl">‚úÖ</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-green-600">Matched Skills</h3>
                            <p class="text-sm text-gray-600" id="matchedSkillsCount">Skills you already have</p>
                        </div>
                    </div>
                    <div id="matchedSkills" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500">
                    <div class="flex items-center mb-4">
                        <div class="bg-red-100 p-2 rounded-full mr-3">
                            <span class="text-2xl">‚ùå</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-red-600">Missing Skills</h3>
                            <p class="text-sm text-gray-600" id="missingSkillsCount">Skills to develop</p>
                        </div>
                    </div>
                    <div id="missingSkills" class="flex flex-wrap gap-2"></div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-xl font-semibold text-blue-600 mb-4">AI Feedback</h3>
                <div id="feedback" class="space-y-3"></div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-semibold text-purple-600 mb-4">üìö Recommended Courses</h3>
                <div id="courses" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>
    </section>

    <section id="matches" class="py-12 hidden">
        <div class="max-w-6xl mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-8">Job Matches</h2>
            <div id="jobMatches" class="space-y-6"></div>
        </div>
    </section>

    <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-lg">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <p class="text-lg font-semibold">Analyzing resume...</p>
        </div>
    </div>

    <script>
        // API Configuration - Point to fixed backend
        const API_BASE_URL = 'http://localhost:9002';
        
        let currentFileId = null;

        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            
            // Show selected section
            document.getElementById(section).classList.remove('hidden');
        }

        document.getElementById('resumeFile').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            console.log('Uploading file:', file.name);

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_BASE_URL}/upload_resume`, {
                    method: 'POST',
                    body: formData
                });

                console.log('Upload response status:', response.status);
                const result = await response.json();
                console.log('Upload result:', result);

                if (result.success) {
                    currentFileId = result.file_id;
                    document.getElementById('uploadArea').innerHTML = `
                        <div class="text-6xl mb-4 text-green-500">‚úì</div>
                        <p class="text-xl text-green-600 font-semibold">${file.name}</p>
                        <p class="text-gray-500">Ready for analysis</p>
                        <p class="text-sm text-blue-600 mt-2">Skills found: ${result.extracted_skills.length}</p>
                    `;
                    console.log('Skills extracted:', result.extracted_skills);
                } else {
                    alert('Upload failed: ' + result.message);
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload error: ' + error.message);
            }
        });

        async function analyzeResume() {
            if (!currentFileId) {
                alert('Please upload a resume first');
                return;
            }

            const jobDescription = document.getElementById('jobDescription').value;
            if (!jobDescription.trim()) {
                alert('Please enter a job description');
                return;
            }

            console.log('Starting analysis with file_id:', currentFileId);
            document.getElementById('loading').classList.remove('hidden');

            try {
                const formData = new FormData();
                formData.append('file_id', currentFileId);
                formData.append('job_description', jobDescription);

                const response = await fetch(`${API_BASE_URL}/analyze_resume`, {
                    method: 'POST',
                    body: formData
                });

                console.log('Analysis response status:', response.status);
                const result = await response.json();
                console.log('Analysis result:', result);

                document.getElementById('loading').classList.add('hidden');

                if (result.success) {
                    displayResults(result.analysis);
                    await loadJobMatches();
                    showSection('results');
                } else {
                    alert('Analysis failed: ' + result.message);
                }
            } catch (error) {
                console.error('Analysis error:', error);
                document.getElementById('loading').classList.add('hidden');
                alert('Analysis error: ' + error.message);
            }
        }

        function displayResults(analysis) {
            console.log('Displaying analysis results:', analysis);
            
            // Main metrics
            document.getElementById('fitScore').textContent = analysis.fit_score + '%';
            document.getElementById('selectionProb').textContent = analysis.selection_probability + '%';
            document.getElementById('skillMatch').textContent = analysis.skill_match_score + '%';

            // Enhanced matched skills with categories
            const matchedSkillsDiv = document.getElementById('matchedSkills');
            matchedSkillsDiv.innerHTML = '';
            
            if (analysis.matched_skills && analysis.matched_skills.length > 0) {
                // Update count
                document.getElementById('matchedSkillsCount').textContent = `${analysis.matched_skills.length} skills matched`;
                
                analysis.matched_skills.forEach((skill, index) => {
                    const span = document.createElement('span');
                    span.className = 'px-4 py-2 bg-gradient-to-r from-green-100 to-green-200 text-green-800 rounded-full text-sm font-semibold mr-2 mb-2 inline-block shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-105 border border-green-300';
                    span.innerHTML = `<span class="text-green-600 mr-1">‚úì</span>${skill}`;
                    
                    // Add animation delay for staggered appearance
                    span.style.animationDelay = `${index * 0.1}s`;
                    span.style.animation = 'fadeInUp 0.5s ease-out forwards';
                    span.style.opacity = '0';
                    
                    matchedSkillsDiv.appendChild(span);
                });
                
                // Add extra skills if available
                if (analysis.extra_skills && analysis.extra_skills.length > 0) {
                    const extraTitle = document.createElement('div');
                    extraTitle.className = 'w-full text-sm font-semibold text-blue-700 mb-2 mt-4';
                    extraTitle.innerHTML = '<span class="text-blue-600 mr-1">‚≠ê</span>Bonus Skills You Have:';
                    matchedSkillsDiv.appendChild(extraTitle);
                    
                    analysis.extra_skills.forEach((skill, index) => {
                        const span = document.createElement('span');
                        span.className = 'px-4 py-2 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-800 rounded-full text-sm font-semibold mr-2 mb-2 inline-block shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-105 border border-blue-300';
                        span.innerHTML = `<span class="text-blue-600 mr-1">‚≠ê</span>${skill}`;
                        matchedSkillsDiv.appendChild(span);
                    });
                }
            } else {
                document.getElementById('matchedSkillsCount').textContent = 'No skills matched';
                matchedSkillsDiv.innerHTML = '<p class="text-gray-500 italic bg-gray-50 p-4 rounded-lg">No matching skills found. Consider adding more relevant skills to your resume.</p>';
            }

            // Enhanced missing skills with priority
            const missingSkillsDiv = document.getElementById('missingSkills');
            missingSkillsDiv.innerHTML = '';
            
            if (analysis.missing_skills && analysis.missing_skills.length > 0) {
                // Update missing skills count
                document.getElementById('missingSkillsCount').textContent = `${analysis.missing_skills.length} skills to develop`;
                
                analysis.missing_skills.forEach(skill => {
                    const span = document.createElement('span');
                    span.className = 'px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium mr-2 mb-2 inline-block';
                    span.textContent = skill;
                    missingSkillsDiv.appendChild(span);
                });
            } else {
                document.getElementById('missingSkillsCount').textContent = 'Perfect match!';
                missingSkillsDiv.innerHTML = '<p class="text-green-600 font-semibold bg-green-50 p-4 rounded-lg border border-green-200">üéâ Excellent! You have all the required skills for this position.</p>';
            }

            // Enhanced feedback with better formatting
            const feedbackDiv = document.getElementById('feedback');
            feedbackDiv.innerHTML = '';
            if (analysis.feedback && analysis.feedback.length > 0) {
                analysis.feedback.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400 mb-3';
                    
                    const icon = index === 0 ? 'üéØ' : index === 1 ? 'üí°' : 'üìà';
                    div.innerHTML = `<p class="text-blue-800"><span class="text-lg mr-2">${icon}</span>${item}</p>`;
                    feedbackDiv.appendChild(div);
                });
            }

            // Course recommendations
            const coursesDiv = document.getElementById('courses');
            coursesDiv.innerHTML = '';
            if (analysis.course_recommendations && analysis.course_recommendations.length > 0) {
                analysis.course_recommendations.forEach(course => {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-50 p-4 rounded-lg border';
                    div.innerHTML = `
                        <h4 class="font-semibold text-gray-800 mb-2">${course.course_title}</h4>
                        <p class="text-sm text-gray-600 mb-2">Skill: ${course.skill}</p>
                        <p class="text-sm text-gray-600 mb-2">Provider: ${course.provider}</p>
                        <p class="text-sm text-gray-600 mb-2">Duration: ${course.duration}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-green-600">${course.price}</span>
                            <span class="text-xs px-2 py-1 bg-${course.priority === 'High' ? 'red' : 'yellow'}-100 text-${course.priority === 'High' ? 'red' : 'yellow'}-800 rounded">${course.priority}</span>
                        </div>
                    `;
                    coursesDiv.appendChild(div);
                });
            }

            // Add skill analysis breakdown if available
            if (analysis.skill_analysis) {
                addSkillAnalysisSection(analysis.skill_analysis);
            }
        }

        // Add skill analysis breakdown
        function addSkillAnalysisSection(skillAnalysis) {
            const resultsSection = document.getElementById('results');
            let analysisSection = document.getElementById('skillAnalysisSection');
            
            if (!analysisSection) {
                analysisSection = document.createElement('div');
                analysisSection.id = 'skillAnalysisSection';
                analysisSection.className = 'bg-white rounded-xl shadow-lg p-6 mb-8';
                
                const title = document.createElement('h3');
                title.className = 'text-xl font-semibold text-indigo-600 mb-4';
                title.textContent = 'üìä Skill Analysis by Category';
                analysisSection.appendChild(title);
                
                const grid = document.createElement('div');
                grid.id = 'skillAnalysisGrid';
                grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
                analysisSection.appendChild(grid);
                
                resultsSection.appendChild(analysisSection);
            }
            
            const grid = document.getElementById('skillAnalysisGrid');
            grid.innerHTML = '';
            
            Object.entries(skillAnalysis).forEach(([category, data]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'border border-gray-200 rounded-lg p-4';
                
                const percentage = data.match_percentage;
                const barColor = percentage >= 80 ? 'bg-green-500' : percentage >= 60 ? 'bg-yellow-500' : 'bg-red-500';
                
                categoryDiv.innerHTML = `
                    <h4 class="font-semibold text-gray-800 mb-2">${category}</h4>
                    <div class="mb-2">
                        <div class="flex justify-between text-sm mb-1">
                            <span>Match Rate</span>
                            <span class="font-medium">${percentage}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="${barColor} h-2 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-600">
                        <div>‚úÖ Matched: ${data.matched.join(', ') || 'None'}</div>
                        <div class="mt-1">‚ùå Missing: ${data.missing.join(', ') || 'None'}</div>
                    </div>
                `;
                
                grid.appendChild(categoryDiv);
            });
        }

        async function loadJobMatches() {
            try {
                console.log('Loading job matches for file_id:', currentFileId);
                const response = await fetch(`${API_BASE_URL}/match_jobs?file_id=${currentFileId}`);
                const result = await response.json();
                console.log('Job matches result:', result);

                if (result.success) {
                    const jobMatchesDiv = document.getElementById('jobMatches');
                    jobMatchesDiv.innerHTML = '';

                    if (result.matches && result.matches.length > 0) {
                        // Add summary
                        const summaryDiv = document.createElement('div');
                        summaryDiv.className = 'bg-white rounded-xl shadow-lg p-6 mb-6';
                        summaryDiv.innerHTML = `
                            <h3 class="text-xl font-semibold text-indigo-600 mb-4">Job Matching Summary</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-600">${result.eligible_matches}</div>
                                    <div class="text-sm text-gray-600">Eligible Jobs</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-600">${result.best_fit_company}</div>
                                    <div class="text-sm text-gray-600">Best Fit Company</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-purple-600">${result.average_fit_score}%</div>
                                    <div class="text-sm text-gray-600">Average Fit Score</div>
                                </div>
                            </div>
                        `;
                        jobMatchesDiv.appendChild(summaryDiv);

                        result.matches.forEach(match => {
                            const div = document.createElement('div');
                            div.className = 'bg-white rounded-xl shadow-lg p-6';
                            div.innerHTML = `
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="text-xl font-semibold">${match.role_title}</h3>
                                        <p class="text-gray-600">${match.company}</p>
                                        <p class="text-sm text-gray-500">${match.salary_range}</p>
                                        <p class="text-sm text-blue-600">${match.location}</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-2xl font-bold text-indigo-600">${match.fit_score}%</div>
                                        <div class="text-sm text-gray-600">Fit Score</div>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <p class="text-sm text-green-600 bg-green-50 p-2 rounded">${match.eligibility_reason}</p>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <h4 class="font-semibold text-green-600 mb-2">Matched Skills (${match.skills_overlap.length})</h4>
                                        <p class="text-sm">${match.skills_overlap.join(', ') || 'None'}</p>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-red-600 mb-2">Missing Skills (${match.missing_skills.length})</h4>
                                        <p class="text-sm">${match.missing_skills.join(', ') || 'None'}</p>
                                    </div>
                                </div>
                                <div class="mt-4 pt-4 border-t">
                                    <div class="flex justify-between text-sm text-gray-600">
                                        <span>Selection Probability: ${match.selection_probability}%</span>
                                        <span>Skills Match: ${match.exact_matches}/${match.total_required}</span>
                                    </div>
                                </div>
                            `;
                            jobMatchesDiv.appendChild(div);
                        });
                    } else {
                        jobMatchesDiv.innerHTML = `
                            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                                <div class="text-6xl mb-4">üòî</div>
                                <h3 class="text-xl font-semibold text-gray-600 mb-2">No Eligible Job Matches</h3>
                                <p class="text-gray-500">Your current skills don't meet the minimum requirements for available positions. Consider developing more relevant skills.</p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading job matches:', error);
            }
        }

        showSection('hero');
    </script>
</body>
</html>
